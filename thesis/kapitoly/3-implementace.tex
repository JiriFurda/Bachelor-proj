\chapter{Návrh a implementace systému}
Předchozí řešení mých kolegů umožňovalo vyhledávat pouze projekty a vědecké zprávy. Nabízelo se tento obsah rozšířit o výzvy k předkládání návrhů, na základě kterých Evropská komise vybírá organizace či fyzické osoby pro uskutečnění projektů se spolufinancováním Evropské unie.
%[https://ec.europa.eu/info/funding-tenders/opportunities/portal/screen/home 27.4.].
Samotné výzvy jsou ale hodně obecné a zaštiťují mnoho témat napříč různými oblastmi. Dalším úskalím byl nedostatek informací v popisu výzev. Rozsáhlý slovní popis se vztahovat až ke konkrétním tématům. Proto jsem se rozhodl portál nerozšiřovat o výzvy ale právě o zmiňovaná témata.

\section{Extrakce dat}
\blindtext

Pro tyto účely jsem využil aplikační rozhraní nabízené přímo portálem Fundings and Tenders %[https://ec.europa.eu/info/funding-tenders/opportunities/portal/screen/support/apis]
Rozhraní nabízí potřebná data ve formátu JSON, čímž bylo značně zjednodušeno jejich dolování.

\section{Webový portál}
\blindtext

\subsection{Návrh}
\blindtext

\subsection{Struktura adresáře}
Veškeré zdrojové kódy portálu se nachází v adresáři \texttt{portal}. Uvnitř této složky se nachází adresáře odpovídající architektuře MVC.
\begin{itemize}
  \item Složka \texttt{models} obsahuje modely
  \item Složka \texttt{controllers} obsahuje kontrolery
  \item Složka \texttt{templates} obsahuje pohledy
  \item Složka \texttt{static} obsahuje kaskádové styly, zdrojové kódy Vue komponent
  \item Soubor \texttt{app.py} sloužící ke spuštění portálu
\end{itemize}

\subsection{Vue komponenty}
Některé z využívaných faset obsahují i stovky položek a jejich hodnoty mají často dlouhé názvy. Jejich zobrazení pouze v postranním panelu jsem považoval za nedostatečné, proto jsem se rozhodl toto řešení oproti předchozímu řešení portálu přepracovat s využitím technologie Vue.js (představená v kapitole~\ref{section:Vue.js}). Pro každou z faset jsem vytvořil dvě komponenty - položku v postranním panelu a modální okno.

\subsubsection{Postranní panel}
Tento panel je tvořen Vue komponentou \texttt{sidebar-facet-list}, která pro každý faset vytvoří instanci komponenty \texttt{sidebar-facet}
Ve výchozím stavu tento panel nabízí nejvýše pět nejčastěji vyskytujících se hodnot daného fasetu. Ty jsou postupně nahrazovány zvolenými hodnotami. Další hodnoty s menším výskytem jsou dostupné v modálním okně.

\subsubsection*{Modální okno}
Okna jednotlivých faset jsou tvořena instancemi Vue komponenty \texttt{modal-facet}. O jejich vytvoření se stará komponenta \texttt{modal-facet-list}
Rozsáhlejší výpis možností daného fasetu se nyní zobrazují v modálním okně. Zde je možnost současně vidět podstatně více možností a také je možné vypsat jejich hodnoty v plném znění. V tomto okně je obsaženo vstupní pole, které asynchronními dotazy na Elasticsearch vyhledává mezi možnostmi daného fasetu.

\subsubsection*{Fasetová možnost}
Jednotlivé fasetové možnosti jsou reprezentovány komponentou \texttt{option-facet}, která zobrazuje zaškrtávací pole, název dané možnosti a počet výsledků aktuálního vyhledávání obsahující tuto možnost. Při zaškrtnutí možnosti se její data zkopírují do proměnné \texttt{checkedOptions} příslušného fasetu. Tato komponenta se vyskytuje jak v modálním okně, tak i v postranním panelu.


\subsubsection*{Inicializace dat}
Na každé stránce portálu se vyskytuje právě jednou komponenta \texttt{init-facet-data}, která jednorázově obstará naplnění proměnných programovacího jazyka JavaScript.

\subsection{Vyhledávání}
Samotné vyhledávání obstarává třída \texttt{IndexSearch}, při svém vytvoření uloží vstupní parametry a sestaví dotazy pro Elasticsearch. Mezi tyto parametry patří
\begin{itemize}
    \item index, ve kterém se bude hledat
    \item pole dokumentu, ve kterém budou v případě shody zvýrazněna klíčová slova
    \item pole dokumentu, ve kterých se budou klíčová slova hledat
\end{itemize}
\subsubsection*{buildSearch()}
První z dotazů je vytvořen tuto metodou, která zpracuje všechny GET parametry protokolu HTML a v případě shody jejich názvů s některým z faset, přidá tuto hodnotu do dotazu. Tento dotaz se využívá pro hledání v modálním okně fasetu. 

\subsubsection*{buildAggregationsSearch()}
Druhý dotaz vzniká rozšířením dotazu z metody \texttt{buildSearch()}. Je obohacen o agregaci fasetových hodnot, které jsou poté zobrazeny v postranním panelu.

\subsubsection*{prepareLayoutData()}
Poté co byly výše zmíněné dotazy vykonány je třeba výsledky zpracovat a připravit pro předání do odpovídajících Vue komponent. Výsledkem této funkce jsou tři struktury JSON, obsahující data využívané pro inicalizaci komponent v šabloně, zabalení ve slovníku.

%TODO: not so interresting
\begin{verbatim}
{
    "facets":[
    {
        "mostFrequentOptions":[  
            {  
               "count":8748,
               "text":"United Kingdom",
               "value":"United Kingdom"
            },
            {  
               "count":5276,
               "text":"Germany",
               "value":"Germany"
            },
            ...
         ],
         "field":"coordinator.country.keyword",
         "name":"coordcountry",
         "checkedOptions":[  
            {  
               "count":4692,
               "text":"Spain",
               "value":"Spain"
            },
         ],
         "title":"Coord. Country"
     },
     ...
     ]
}
\end{verbatim}

\subsubsection*{createForIndex()}
Protože se v portálu vytváří hledání na vícero místech, byla vytvořena statická metoda třídy \texttt{IndexSearch}, která vrací předpřipravenou instanci této třidy pro hledání v jednom z typů obsahu portálu. Tato funkce očekává ve svém jediném parametru řetězec, určující typ hledání (\texttt{projects}, \texttt{deliverables} nebo \texttt{topics})

\subsubsection*{Hromadné akce}
Pro případy, kdy je potřeba pracovat s několika hledáními naráz, si lze práci ušetřit využitím dalších statických metod třídy \texttt{IndexSearch} a to konkrétně metoda \texttt{createForEveryIndex()}, která vrací slovník se všemi třemi možnými typy hledání, a poté také \texttt{executeMany()}, která vykoná hledání všech instancí \texttt{IndexSearch} ve slovníku předaném této funkci v parametru. 

\subsection{Vyhledávání hodnot faset}
Protože ve fasetách lze asynchronně vyhledávat, bylo nutné napsat aplikační rozhraní propojující databázi Elasticsearch s Vue komponentou reprezentující toto vyhledávání. Tuto činnost obstarává funkce \texttt{showApi} v kontroleru \texttt{facet\_controller}.

Jako parametr, který je předán cestou URL adresy očekává platný název fasety, pro kterou existuje model třídy \texttt{Facet}. Další parametry jsou předávány metodou GET protokolu HTTP. Prvním povinným parametrem je znění původního dotazu na Elasticsearch, díky tomuto parametru výsledky funkce korespondují s kontextem aktuálního vyhledávání v portálu. Dalším parametrem je pak klíčové slovo nebo jeho část, které se hledá v dostupných hodnotách fasety. 

Po úspěšném dotazu funkce vrací strukturu JSON ve stejném tvaru jako například v \texttt{checkedOptions} zmiňovaném v kapitole Vyhledávání %TODO: reference

\subsection{Model fasety}